<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMIR AI PRO v8.0 - Enterprise Dashboard</title>
    <style>
        /* Enterprise Design System */
        :root {
            --color-bg: #0a0e27;
            --color-surface: rgba(26, 32, 64, 0.5);
            --color-primary: #00d4ff;
            --color-success: #00ff88;
            --color-danger: #ff4444;
            --color-warning: #ffc107;
            --color-text: #e0e6ff;
            --color-text-muted: #6b7390;
            --font-primary: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, #0a0e27 0%, #1a2040 100%);
            color: var(--color-text);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--color-surface);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .brand { font-size: 28px; font-weight: 800; color: var(--color-primary); }
        .status { color: var(--color-success); font-size: 14px; }

        .coins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .coin-card {
            background: var(--color-surface);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .coin-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .coin-symbol { font-size: 20px; font-weight: 700; color: var(--color-primary); }
        .coin-price { font-size: 28px; font-weight: 800; font-family: var(--font-mono); }
        .price-change { font-size: 14px; font-weight: 600; padding: 5px 10px; border-radius: 5px; }
        .positive { background: rgba(0, 255, 136, 0.15); color: var(--color-success); }
        .negative { background: rgba(255, 68, 68, 0.15); color: var(--color-danger); }

        .layer-group { margin-bottom: 20px; }
        .layer-title { font-size: 12px; text-transform: uppercase; color: var(--color-text-muted); margin-bottom: 10px; }
        .layer-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .layer-name { font-size: 13px; color: var(--color-text-muted); }
        .layer-value { font-size: 13px; font-weight: 700; font-family: var(--font-mono); }

        .signal { padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .signal-buy { background: rgba(0, 255, 136, 0.15); color: var(--color-success); }
        .signal-sell { background: rgba(255, 68, 68, 0.15); color: var(--color-danger); }
        .signal-neutral { background: rgba(255, 193, 7, 0.15); color: var(--color-warning); }

        .score-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .score-bar { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
        .score-fill { height: 100%; background: linear-gradient(90deg, var(--color-success), var(--color-primary)); }

        .manual-section { background: var(--color-surface); padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .input-group { display: flex; gap: 10px; }
        .text-input { flex: 1; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(0,212,255,0.3); border-radius: 6px; color: var(--color-text); }
        .btn-primary { padding: 12px 24px; background: linear-gradient(135deg, var(--color-primary), #0099ff); border: none; border-radius: 6px; color: #0a0e27; font-weight: 700; cursor: pointer; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">ü§ñ DEMIR AI PRO v8.0</div>
            <div class="status" id="status">‚óè LIVE TRADING</div>
        </header>

        <section class="manual-section">
            <h3 style="margin-bottom: 15px; color: var(--color-primary);">üîç Manuel Coin Analizi</h3>
            <div class="input-group">
                <input type="text" class="text-input" id="coinInput" placeholder="Coin sembol√º gir (√∂r: SOLUSDT, BNBUSDT)" maxlength="20">
                <button class="btn-primary" id="analyzeBtn" onclick="analyzeManualCoin()">üöÄ Analiz Et</button>
            </div>
            <div id="manualResult" style="margin-top: 20px;"></div>
        </section>

        <h2 style="margin-bottom: 20px; color: var(--color-primary);">üìà Ana Coin Analizi</h2>
        <div class="coins-grid" id="coinsGrid">
            <!-- Dynamically loaded -->
        </div>
    </div>

    <script>
        const FIXED_SYMBOLS = ['BTCUSDT', 'ETHUSDT', 'LTCUSDT'];
        let ws = null;

        // Initialize dashboard
        async function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            await loadFixedCoins();
            connectWebSocket();
        }

        // Load fixed coins (BTCUSDT, ETHUSDT, LTCUSDT)
        async function loadFixedCoins() {
            const grid = document.getElementById('coinsGrid');
            grid.innerHTML = '<div style="text-align:center; color: var(--color-text-muted); padding: 40px;">‚è≥ Veriler y√ºkleniyor...</div>';

            try {
                for (const symbol of FIXED_SYMBOLS) {
                    const data = await fetchCoinAnalysis(symbol);
                    if (data && data.success) {
                        renderCoinCard(symbol, data.analysis);
                    }
                }
            } catch (err) {
                console.error('‚ùå Load error:', err);
                grid.innerHTML = '<div style="text-align:center; color: var(--color-danger); padding: 40px;">‚ùå Veri y√ºkleme hatasƒ±</div>';
            }
        }

        // Fetch coin analysis from API
        async function fetchCoinAnalysis(symbol) {
            try {
                const response = await fetch(`/api/analyze/${symbol}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                console.log(`‚úÖ ${symbol} data fetched:`, data);
                return data;
            } catch (err) {
                console.error(`‚ùå Fetch error for ${symbol}:`, err);
                return null;
            }
        }

        // Render coin card
        function renderCoinCard(symbol, analysis) {
            const grid = document.getElementById('coinsGrid');
            
            // Clear loading message on first render
            if (grid.innerHTML.includes('Veriler y√ºkleniyor')) {
                grid.innerHTML = '';
            }

            const card = document.createElement('article');
            card.className = 'coin-card';
            card.id = `card-${symbol}`;

            const symbolDisplay = {
                'BTCUSDT': '‚Çø BTC/USDT',
                'ETHUSDT': 'Œû ETH/USDT',
                'LTCUSDT': '≈Å LTC/USDT'
            }[symbol] || symbol;

            const price = analysis.price || 0;
            const change = analysis.change_24h || 0;
            const score = analysis.composite_score || 0;
            const layers = analysis.layers || {};

            card.innerHTML = `
                <div class="coin-header">
                    <div>
                        <div class="coin-symbol">${symbolDisplay}</div>
                        <div class="coin-price">$${price.toFixed(2)}</div>
                        <div class="price-change ${change >= 0 ? 'positive' : 'negative'}">
                            ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                        </div>
                    </div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üìä TECHNICAL ANALYSIS (40 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">RSI (14)</span><span class="layer-value">${getVal(layers.rsi_14, 50)}</span></div>
                    <div class="layer-item"><span class="layer-name">Stochastic %K</span><span class="layer-value">${getVal(layers.stochastic_k, 50)}</span></div>
                    <div class="layer-item"><span class="layer-name">MACD</span><span class="signal ${getSignalClass(layers.macd_trend)}">${getVal(layers.macd_trend, 'NEUTRAL')}</span></div>
                    <div class="layer-item"><span class="layer-name">BB Position</span><span class="layer-value">${getVal(layers.bb_position, 'MIDDLE')}</span></div>
                    <div class="layer-item"><span class="layer-name">EMA Trend</span><span class="signal ${getSignalClass(layers.ema_trend)}">${getVal(layers.ema_trend, 'MIXED')}</span></div>
                    <div class="layer-item"><span class="layer-name">ATR (14)</span><span class="layer-value">${getVal(layers.atr, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">MFI</span><span class="layer-value">${getVal(layers.mfi, 50)}</span></div>
                    <div class="layer-item"><span class="layer-name">CCI</span><span class="layer-value">${getVal(layers.cci, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">ADX</span><span class="layer-value">${getVal(layers.adx, 25)}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üì¶ VOLUME ANALYSIS (10 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">OBV Trend</span><span class="signal ${getSignalClass(layers.obv_trend)}">${getVal(layers.obv_trend, 'NEUTRAL')}</span></div>
                    <div class="layer-item"><span class="layer-name">VWAP Signal</span><span class="signal ${getSignalClass(layers.vwap_signal)}">${getVal(layers.vwap_signal, 'NEUTRAL')}</span></div>
                    <div class="layer-item"><span class="layer-name">Volume Ratio</span><span class="layer-value">${getVal(layers.volume_ratio, 1.0)}</span></div>
                    <div class="layer-item"><span class="layer-name">CMF Signal</span><span class="signal ${getSignalClass(layers.cmf_signal)}">${getVal(layers.cmf_signal, 'NEUTRAL')}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üåä VOLATILITY (9 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">Historical Vol</span><span class="layer-value">${getVal(layers.historical_volatility, 30)}</span></div>
                    <div class="layer-item"><span class="layer-name">BB Width</span><span class="layer-value">${getVal(layers.bb_width, 4)}</span></div>
                    <div class="layer-item"><span class="layer-name">ATR %</span><span class="layer-value">${getVal(layers.atr_percent, 0)}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">ü§ñ AI/ML MODELS (4 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">LSTM Forecast</span><span class="layer-value">${getVal(layers.lstm_forecast, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">XGBoost</span><span class="signal ${getSignalClass(layers.xgboost_signal)}">${getVal(layers.xgboost_signal, 'NEUTRAL')}</span></div>
                    <div class="layer-item"><span class="layer-name">Neural Net</span><span class="layer-value">${getVal(layers.neural_net_prediction, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">Random Forest</span><span class="signal ${getSignalClass(layers.random_forest_signal)}">${getVal(layers.random_forest_signal, 'NORMAL')}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üé≠ SENTIMENT (4 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">Fear & Greed</span><span class="layer-value">${getVal(layers.fear_greed_index, 50)}</span></div>
                    <div class="layer-item"><span class="layer-name">Funding Rate</span><span class="layer-value">${getVal(layers.funding_rate, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">Order Book</span><span class="signal ${getSignalClass(layers.orderbook_signal)}">${getVal(layers.orderbook_signal, 'BALANCED')}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üåê MARKET REGIME (4 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">Regime Type</span><span class="signal ${getSignalClass(layers.regime_type)}">${getVal(layers.regime_type, 'TRANSITIONAL')}</span></div>
                    <div class="layer-item"><span class="layer-name">Confidence</span><span class="layer-value">${getVal(layers.regime_confidence, 0.5)}</span></div>
                    <div class="layer-item"><span class="layer-name">Market Phase</span><span class="signal ${getSignalClass(layers.market_phase)}">${getVal(layers.market_phase, 'CONSOLIDATION')}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">‚è∞ MULTI-TIMEFRAME (8 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">Overall Trend</span><span class="signal ${getSignalClass(layers.overall_trend)}">${getVal(layers.overall_trend, 'MIXED')}</span></div>
                    <div class="layer-item"><span class="layer-name">Confluence</span><span class="layer-value">${getVal(layers.timeframe_confluence, 50)}</span></div>
                </div>

                <div class="layer-group">
                    <div class="layer-title">üéØ ENSEMBLE META (4 LAYERS)</div>
                    <div class="layer-item"><span class="layer-name">Signal Strength</span><span class="layer-value">${getVal(layers.signal_strength, 0)}</span></div>
                    <div class="layer-item"><span class="layer-name">Risk/Reward</span><span class="layer-value">${getVal(layers.risk_reward_ratio, 2.0)}</span></div>
                    <div class="layer-item"><span class="layer-name">Confidence</span><span class="layer-value">${getVal(layers.confidence_score, 50)}</span></div>
                    <div class="layer-item"><span class="layer-name">Trade Quality</span><span class="layer-value">${getVal(layers.trade_quality, 50)}</span></div>
                </div>

                <div class="score-section">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                        <span style="color: var(--color-text-muted); font-size: 12px; text-transform: uppercase;">COMPOSITE SCORE</span>
                        <span style="color: var(--color-success); font-size: 20px; font-weight: 800;">${score}/100</span>
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${score}%"></div>
                    </div>
                </div>
            `;

            grid.appendChild(card);
        }

        // Manual coin analysis
        async function analyzeManualCoin() {
            const input = document.getElementById('coinInput');
            const btn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('manualResult');
            
            const symbol = input.value.trim().toUpperCase();
            if (!symbol) {
                alert('L√ºtfen bir coin sembol√º girin');
                return;
            }
            
            const formattedSymbol = symbol.endsWith('USDT') ? symbol : `${symbol}USDT`;
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Analiz ediliyor... <span class="loading"></span>';
            
            try {
                const data = await fetchCoinAnalysis(formattedSymbol);
                
                if (data && data.success) {
                    const analysis = data.analysis;
                    resultDiv.innerHTML = `
                        <div style="background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2); border-radius: 8px; padding: 20px; margin-top: 15px;">
                            <h4 style="color: var(--color-primary); margin-bottom: 15px;">${formattedSymbol} Analiz Sonucu</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 11px; color: var(--color-text-muted); text-transform: uppercase;">Fiyat</div>
                                    <div style="font-size: 24px; font-weight: 700; font-family: var(--font-mono);">$${analysis.price.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: var(--color-text-muted); text-transform: uppercase;">24h Deƒüi≈üim</div>
                                    <div style="font-size: 24px; font-weight: 700; color: ${analysis.change_24h >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">
                                        ${analysis.change_24h >= 0 ? '+' : ''}${analysis.change_24h.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 11px; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px;">Composite Score</div>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${analysis.composite_score}%"></div>
                                </div>
                                <div style="text-align: center; font-size: 20px; font-weight: 800; margin-top: 8px; color: var(--color-success);">
                                    ${analysis.composite_score}/100
                                </div>
                            </div>
                            <div style="background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.1); border-radius: 6px; padding: 12px; font-size: 13px; line-height: 1.6; color: var(--color-text);">
                                ${analysis.ai_commentary || 'Analiz devam ediyor...'}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color: var(--color-danger); text-align: center; padding: 20px;">‚ùå ${data?.error || 'Analiz ba≈üarƒ±sƒ±z'}</div>`;
                }
            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                resultDiv.innerHTML = `<div style="color: var(--color-danger); text-align: center; padding: 20px;">‚ùå Hata: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Analiz Et';
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
            
            console.log('üîå Connecting WebSocket:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                document.getElementById('status').textContent = '‚óè LIVE TRADING';
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® WebSocket message:', data);
                    // Handle real-time updates here
                } catch (err) {
                    console.error('‚ùå WebSocket parse error:', err);
                }
            };
            
            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                document.getElementById('status').textContent = '‚ö†Ô∏è CONNECTION ERROR';
            };
            
            ws.onclose = () => {
                console.log('‚ö†Ô∏è WebSocket disconnected');
                document.getElementById('status').textContent = '‚ö†Ô∏è RECONNECTING...';
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Utility functions
        function getVal(value, fallback) {
            if (value === undefined || value === null || value === '') return fallback;
            if (typeof value === 'number') return value.toFixed(2);
            return value;
        }

        function getSignalClass(signal) {
            if (!signal) return 'signal-neutral';
            const s = String(signal).toUpperCase();
            if (s.includes('BUY') || s.includes('BULLISH') || s.includes('POSITIVE') || s.includes('ACCUMULATION')) return 'signal-buy';
            if (s.includes('SELL') || s.includes('BEARISH') || s.includes('NEGATIVE') || s.includes('DISTRIBUTION')) return 'signal-sell';
            return 'signal-neutral';
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('coinInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') analyzeManualCoin();
                });
            }
            initDashboard();
        });
    </script>
</body>
</html>