<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>DEMIR AI PRO â€“ Trading Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg: #020617;
            --bg-alt: #020720;
            --card: #020818;
            --border: #1f2933;
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.15);
            --danger: #ef4444;
            --danger-soft: rgba(239, 68, 68, 0.12);
            --warning: #eab308;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --tab-bg: #020820;
            --tab-active: #0b1120;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
            color: var(--text);
        }

        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            border-bottom: 1px solid var(--border);
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(14px);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, #22c55e, #16a34a, #0f766e);
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.75);
        }

        .brand-title {
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.95rem;
        }

        .pill {
            font-size: 0.75rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--muted);
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--muted);
        }

        .status-label {
            color: var(--muted);
        }

        .status-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        main {
            flex: 1;
        }

        .layout {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 1.25rem 1.5rem;
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 1rem;
        }

        @media (max-width: 1100px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
            border-radius: 0.9rem;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: 0 18px 55px rgba(15, 23, 42, 0.9);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 55%);
            opacity: 0.35;
            pointer-events: none;
        }

        .card-header {
            padding: 0.75rem 0.9rem 0.35rem;
            border-bottom: 1px solid rgba(31, 41, 55, 0.7);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .card-title span.icon {
            font-size: 1rem;
        }

        .card-subtitle {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .tabs {
            display: flex;
            background: var(--tab-bg);
            border-radius: 999px;
            padding: 0.15rem;
            gap: 0.15rem;
        }

        .tab {
            flex: 1;
            padding: 0.25rem 0.35rem;
            border-radius: 999px;
            font-size: 0.75rem;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            color: var(--muted);
            user-select: none;
        }

        .tab.active {
            background: var(--tab-active);
            border-color: rgba(148, 163, 184, 0.7);
            color: var(--text);
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 0 24px rgba(34, 197, 94, 0.45);
        }

        .card-body {
            padding: 0.75rem 0.9rem 0.85rem;
            position: relative;
            z-index: 1;
        }

        /* Left side: price list + layers */
        .price-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .price-item {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.95));
            border-radius: 0.75rem;
            border: 1px solid rgba(31, 41, 55, 0.9);
            padding: 0.5rem 0.55rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.4rem;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .price-item::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 120% -20%, rgba(34, 197, 94, 0.12), transparent 60%);
            opacity: 0.7;
        }

        .price-main {
            z-index: 1;
        }

        .coin-symbol {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .coin-price {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .coin-change {
            font-size: 0.75rem;
            padding: 0.12rem 0.4rem;
            border-radius: 999px;
            text-align: right;
        }

        .change-pos {
            color: #4ade80;
            background: rgba(22, 163, 74, 0.16);
        }

        .change-neg {
            color: #f97373;
            background: rgba(185, 28, 28, 0.18);
        }

        .change-neutral {
            color: var(--muted);
            background: rgba(148, 163, 184, 0.16);
        }

        .coin-meta {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .ai-badge {
            font-size: 0.7rem;
            padding: 0.12rem 0.4rem;
            border-radius: 999px;
            border: 1px solid rgba(34, 197, 94, 0.6);
            color: #bbf7d0;
            background: var(--accent-soft);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .section-title {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .layers-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.45rem;
        }

        @media (max-width: 800px) {
            .layers-grid {
                grid-template-columns: 1fr;
            }
        }

        .layer-row {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .layer-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.72rem;
            color: var(--muted);
        }

        .layer-name {
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .layer-value {
            color: #e5e7eb;
        }

        .layer-bar-outer {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: radial-gradient(circle at top, #020617, #020617);
            overflow: hidden;
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        .layer-bar-inner {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #22c55e, #3b82f6);
            box-shadow: 0 0 16px rgba(34, 197, 94, 0.78);
            transition: width 0.35s ease-out;
            width: 0%;
        }

        /* Right side: AI signals */
        .signals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .signals-meta {
            font-size: 0.72rem;
            color: var(--muted);
        }

        .signals-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.45rem;
        }

        .signal-card {
            border-radius: 0.7rem;
            padding: 0.45rem 0.5rem;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.96));
            position: relative;
            overflow: hidden;
        }

        .signal-badge {
            font-size: 0.7rem;
            padding: 0.07rem 0.4rem;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .signal-strong-buy {
            color: #bbf7d0;
            background: var(--accent-soft);
            border: 1px solid rgba(34, 197, 94, 0.7);
        }

        .signal-strong-sell {
            color: #fecaca;
            background: var(--danger-soft);
            border: 1px solid rgba(248, 113, 113, 0.75);
        }

        .signal-neutral {
            color: #e5e7eb;
            background: rgba(148, 163, 184, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.6);
        }

        .signal-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.2rem;
        }

        .signal-symbol {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .signal-detail {
            font-size: 0.72rem;
            color: var(--muted);
        }

        .signal-confidence {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .signal-time {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .signal-models {
            margin-top: 0.3rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .signal-model-chip {
            font-size: 0.7rem;
            padding: 0.1rem 0.35rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(31, 41, 55, 0.9);
            color: var(--muted);
        }

        .signal-model-chip strong {
            color: #e5e7eb;
        }

        /* Action bar */
        .action-bar {
            border-top: 1px solid rgba(31, 41, 55, 0.9);
            padding: 0.55rem 0.9rem 0.7rem;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.85));
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            align-items: center;
            justify-content: space-between;
        }

        .action-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            font-size: 0.76rem;
        }

        .action-line {
            display: flex;
            gap: 0.25rem;
            align-items: baseline;
        }

        .label-muted {
            color: var(--muted);
        }

        .value-strong {
            color: #e5e7eb;
            font-weight: 500;
        }

        .value-highlight {
            color: #bbf7d0;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .btn {
            border-radius: 999px;
            padding: 0.28rem 0.75rem;
            font-size: 0.8rem;
            border: 1px solid transparent;
            cursor: pointer;
            background: transparent;
            color: var(--text);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-buy {
            background: var(--accent-soft);
            border-color: rgba(34, 197, 94, 0.8);
            color: #ecfdf5;
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.8);
        }

        .btn-sell {
            background: var(--danger-soft);
            border-color: rgba(248, 113, 113, 0.9);
            color: #fee2e2;
        }

        .btn-close {
            border-color: rgba(148, 163, 184, 0.8);
            color: var(--muted);
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        /* Coin add form */
        .coin-form {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.4rem;
        }

        .coin-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            padding: 0.3rem 0.6rem;
            font-size: 0.78rem;
        }

        .coin-input::placeholder {
            color: #6b7280;
            text-transform: uppercase;
        }

        .btn-add-coin {
            border-radius: 999px;
            padding: 0.3rem 0.7rem;
            border: 1px solid rgba(34, 197, 94, 0.8);
            background: rgba(22, 163, 74, 0.15);
            color: #bbf7d0;
            font-size: 0.78rem;
            cursor: pointer;
        }

        .footnote {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.3rem;
        }

        .error-text {
            font-size: 0.7rem;
            color: #fecaca;
            margin-top: 0.2rem;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header>
        <div class="header-inner">
            <div class="brand">
                <div class="brand-logo"></div>
                <div>
                    <div class="brand-title">DEMIR AI PRO</div>
                    <div class="card-subtitle">Ultra AI Trading Terminal â€¢ v8.0</div>
                </div>
                <span class="pill">24/7 LIVE</span>
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="ai-status-dot"></span>
                    <span class="status-label">AI Engine:</span>
                    <span class="status-value" id="ai-status-text">BaÄŸlanÄ±yor...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">WebSocket:</span>
                    <span class="status-value" id="ws-status">Disconnected</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Latency:</span>
                    <span class="status-value" id="latency-text">â€“</span>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="layout">

            <!-- LEFT: Price + Layers -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">
                            <span class="icon">ðŸ“ˆ</span>
                            Market Overview & Layers
                        </div>
                        <div class="card-subtitle">GerÃ§ek zamanlÄ± fiyatlar + 127-layer Ã¶zet</div>
                    </div>
                    <div class="tabs" id="market-tabs">
                        <div class="tab active" data-tab="core">Core (BTC / ETH / LTC)</div>
                        <div class="tab" data-tab="custom">Custom Coins</div>
                    </div>
                </div>
                <div class="card-body">

                    <!-- CORE TAB -->
                    <div id="tab-core" class="tab-panel">
                        <div class="section-title">Core Coins</div>
                        <div class="price-list" id="core-price-list">
                            <!-- JS ile doldurulacak -->
                        </div>

                        <div class="section-title" style="margin-top:0.6rem;">Layer Status (Ã–zet)</div>
                        <div class="layers-grid">
                            <div class="layer-row">
                                <div class="layer-label">
                                    <span class="layer-name">Momentum</span>
                                    <span class="layer-value" id="layer-momentum-value">â€“</span>
                                </div>
                                <div class="layer-bar-outer">
                                    <div class="layer-bar-inner" id="layer-momentum-bar"></div>
                                </div>
                            </div>

                            <div class="layer-row">
                                <div class="layer-label">
                                    <span class="layer-name">Volatility</span>
                                    <span class="layer-value" id="layer-volatility-value">â€“</span>
                                </div>
                                <div class="layer-bar-outer">
                                    <div class="layer-bar-inner" id="layer-volatility-bar"></div>
                                </div>
                            </div>

                            <div class="layer-row">
                                <div class="layer-label">
                                    <span class="layer-name">Volume</span>
                                    <span class="layer-value" id="layer-volume-value">â€“</span>
                                </div>
                                <div class="layer-bar-outer">
                                    <div class="layer-bar-inner" id="layer-volume-bar"></div>
                                </div>
                            </div>

                            <div class="layer-row">
                                <div class="layer-label">
                                    <span class="layer-name">Sentiment</span>
                                    <span class="layer-value" id="layer-sentiment-value">â€“</span>
                                </div>
                                <div class="layer-bar-outer">
                                    <div class="layer-bar-inner" id="layer-sentiment-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CUSTOM TAB -->
                    <div id="tab-custom" class="tab-panel hidden">
                        <div class="section-title">Custom Coins</div>
                        <div class="price-list" id="custom-price-list">
                            <!-- JS ile doldurulacak -->
                        </div>

                        <form class="coin-form" id="coin-form">
                            <input
                                id="coin-input"
                                class="coin-input"
                                type="text"
                                placeholder="Ã¶rn. XRPUSDT"
                                autocomplete="off"
                            />
                            <button type="submit" class="btn-add-coin">Ekle</button>
                        </form>
                        <div class="footnote">
                            Not: Core coinler (BTCUSDT, ETHUSDT, LTCUSDT) sabittir, buradan kaldÄ±rÄ±lamaz.
                        </div>
                        <div class="error-text hidden" id="coin-error"></div>
                    </div>
                </div>
            </section>

            <!-- RIGHT: AI Signals -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">
                            <span class="icon">ðŸ¤–</span>
                            DEMIR AI Signals
                        </div>
                        <div class="card-subtitle">Ensemble AI (LSTM + XGB + RF + GB) â€¢ GerÃ§ek sinyaller</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="signals-header">
                        <div>
                            <div class="section-title" style="margin-bottom:0.2rem;">AI Sinyalleri</div>
                            <div class="signals-meta" id="signals-meta-text">HenÃ¼z veri yok</div>
                        </div>
                        <div class="ai-badge">Ultra AI Online</div>
                    </div>

                    <div class="signals-grid" id="signals-grid">
                        <!-- Her coin iÃ§in sinyal kartlarÄ± JS ile doldurulacak -->
                    </div>
                </div>

                <div class="action-bar">
                    <div class="action-info">
                        <div class="action-line">
                            <span class="label-muted">SeÃ§ili Coin:</span>
                            <span class="value-strong" id="selected-coin">BTCUSDT</span>
                        </div>
                        <div class="action-line">
                            <span class="label-muted">AI Ã–nerisi:</span>
                            <span class="value-highlight" id="ai-recommendation">â€“</span>
                        </div>
                        <div class="action-line">
                            <span class="label-muted">Ortalama GÃ¼ven:</span>
                            <span class="value-strong" id="ai-confidence">â€“</span>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn btn-buy" id="btn-buy" disabled>BUY</button>
                        <button class="btn btn-sell" id="btn-sell" disabled>SELL</button>
                        <button class="btn btn-close" id="btn-close" disabled>Close</button>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
(function () {
    "use strict";

    const API_BASE = "";
    const CORE_COINS = ["BTCUSDT", "ETHUSDT", "LTCUSDT"];

    const state = {
        coins: [...CORE_COINS],
        prices: {},
        aiSignals: {},
        selectedCoin: "BTCUSDT",
        lastWsPing: null,
        ws: null,
        wsReconnectAttempts: 0,
        wsConnected: false
    };

    function $(id) {
        return document.getElementById(id);
    }

    const corePriceListEl = $("core-price-list");
    const customPriceListEl = $("custom-price-list");
    const aiStatusDotEl = $("ai-status-dot");
    const aiStatusTextEl = $("ai-status-text");
    const wsStatusEl = $("ws-status");
    const latencyTextEl = $("latency-text");
    const signalsGridEl = $("signals-grid");
    const signalsMetaTextEl = $("signals-meta-text");
    const selectedCoinEl = $("selected-coin");
    const aiRecommendationEl = $("ai-recommendation");
    const aiConfidenceEl = $("ai-confidence");
    const momentumValueEl = $("layer-momentum-value");
    const momentumBarEl = $("layer-momentum-bar");
    const volatilityValueEl = $("layer-volatility-value");
    const volatilityBarEl = $("layer-volatility-bar");
    const volumeValueEl = $("layer-volume-value");
    const volumeBarEl = $("layer-volume-bar");
    const sentimentValueEl = $("layer-sentiment-value");
    const sentimentBarEl = $("layer-sentiment-bar");
    const coinFormEl = $("coin-form");
    const coinInputEl = $("coin-input");
    const coinErrorEl = $("coin-error");
    const btnBuyEl = $("btn-buy");
    const btnSellEl = $("btn-sell");
    const btnCloseEl = $("btn-close");

    // ---- TAB SWITCHING ----
    function initTabs() {
        const tabs = document.querySelectorAll("#market-tabs .tab");
        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                tab.classList.add("active");

                const target = tab.getAttribute("data-tab");
                document.querySelectorAll(".tab-panel").forEach(panel => {
                    panel.classList.toggle("hidden", panel.id !== `tab-${target}`);
                });
            });
        });
    }

    // ---- FETCH COIN LIST FROM BACKEND ----
    async function fetchCoins() {
        try {
            const res = await fetch(`${API_BASE}/api/coins`, {cache: "no-store"});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (data && Array.isArray(data.coins)) {
                // Core coinler zaten zorunlu, backend'den gelenleri birleÅŸtir
                const set = new Set(CORE_COINS);
                data.coins.forEach(sym => set.add(sym));
                state.coins = Array.from(set);
            }
        } catch (err) {
            console.error("fetchCoins error:", err);
        }
    }

    // ---- FETCH PRICES FROM BACKEND ----
    async function fetchPrices() {
        try {
            const qs = encodeURIComponent(state.coins.join(","));
            const res = await fetch(`${API_BASE}/api/prices?symbols=${qs}`, {cache: "no-store"});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (data && data.prices && typeof data.prices === "object") {
                state.prices = data.prices;
                renderPrices();
            }
        } catch (err) {
            console.error("fetchPrices error:", err);
        }
    }

    function renderPrices() {
        corePriceListEl.innerHTML = "";
        customPriceListEl.innerHTML = "";
        const customCoins = state.coins.filter(sym => !CORE_COINS.includes(sym));

        for (const symbol of CORE_COINS) {
            const item = createPriceItem(symbol, state.prices[symbol]);
            corePriceListEl.appendChild(item);
        }

        for (const symbol of customCoins) {
            const item = createPriceItem(symbol, state.prices[symbol]);
            customPriceListEl.appendChild(item);
        }
    }

    function createPriceItem(symbol, info) {
        const el = document.createElement("div");
        el.className = "price-item";
        el.dataset.symbol = symbol;
        el.addEventListener("click", () => {
            state.selectedCoin = symbol;
            updateActionBarFromSignal();
        });

        const price = info && typeof info.price === "number" ? info.price : null;
        const change = info && typeof info.change_24h === "number" ? info.change_24h : null;

        const changeClass =
            change === null
                ? "change-neutral"
                : change > 0
                ? "change-pos"
                : change < 0
                ? "change-neg"
                : "change-neutral";

        el.innerHTML = `
            <div class="price-main">
                <div class="coin-symbol">${symbol}</div>
                <div class="coin-meta">
                    24h deÄŸiÅŸim: ${change === null ? "â€“" : change.toFixed(2) + "%"}
                </div>
            </div>
            <div class="price-main">
                <div class="coin-price">
                    ${price === null ? "â€“" : "$" + price.toFixed(2)}
                </div>
            </div>
            <div class="price-main" style="text-align:right;">
                <div class="coin-change ${changeClass}">
                    ${change === null ? "â€“" : (change > 0 ? "+" : "") + change.toFixed(2) + "%"}
                </div>
                <div class="ai-badge">AI MONITOR</div>
            </div>
        `;
        return el;
    }

    // ---- COIN FORM ----
    function initCoinForm() {
        if (!coinFormEl) return;
        coinFormEl.addEventListener("submit", async (ev) => {
            ev.preventDefault();
            const raw = (coinInputEl.value || "").trim().toUpperCase();
            coinErrorEl.classList.add("hidden");
            coinErrorEl.textContent = "";
            if (!raw) {
                return;
            }
            if (CORE_COINS.includes(raw)) {
                coinErrorEl.textContent = "Bu coin zaten core listede.";
                coinErrorEl.classList.remove("hidden");
                return;
            }
            if (state.coins.includes(raw)) {
                coinErrorEl.textContent = "Bu coin zaten eklenmiÅŸ.";
                coinErrorEl.classList.remove("hidden");
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/api/coins/add`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({symbol: raw})
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data && data.success) {
                    const set = new Set(state.coins);
                    set.add(raw);
                    state.coins = Array.from(set);
                    coinInputEl.value = "";
                    await fetchPrices();
                } else {
                    throw new Error(data && data.message ? data.message : "Bilinmeyen hata");
                }
            } catch (err) {
                console.error("add coin error:", err);
                coinErrorEl.textContent = "Coin eklenemedi. Sembol veya backend cevabÄ±nÄ± kontrol et.";
                coinErrorEl.classList.remove("hidden");
            }
        });
    }

    // ---- LAYER / AI STATUS UPDATE ----
    function updateLayerSummaryFromSignal() {
        const sig = state.aiSignals[state.selectedCoin];
        if (!sig || !sig.layer_summary) {
            momentumValueEl.textContent = "â€“";
            momentumBarEl.style.width = "0%";
            volatilityValueEl.textContent = "â€“";
            volatilityBarEl.style.width = "0%";
            volumeValueEl.textContent = "â€“";
            volumeBarEl.style.width = "0%";
            sentimentValueEl.textContent = "â€“";
            sentimentBarEl.style.width = "0%";
            return;
        }

        const { momentum, volatility, volume, sentiment } = sig.layer_summary;

        const safeNum = (v) => (typeof v === "number" && isFinite(v) ? v : 0);

        const m = safeNum(momentum);
        const v = safeNum(volatility);
        const vol = safeNum(volume);
        const s = safeNum(sentiment);

        momentumValueEl.textContent = `${m.toFixed(0)} / 100`;
        momentumBarEl.style.width = `${Math.max(0, Math.min(100, m))}%`;

        volatilityValueEl.textContent = `${v.toFixed(0)} / 100`;
        volatilityBarEl.style.width = `${Math.max(0, Math.min(100, v))}%`;

        volumeValueEl.textContent = `${vol.toFixed(0)} / 100`;
        volumeBarEl.style.width = `${Math.max(0, Math.min(100, vol))}%`;

        sentimentValueEl.textContent = `${s.toFixed(0)} / 100`;
        sentimentBarEl.style.width = `${Math.max(0, Math.min(100, s))}%`;
    }

    // ---- RENDER AI SIGNAL CARDS ----
    function renderSignals() {
        const symbols = state.coins;
        signalsGridEl.innerHTML = "";
        if (!symbols.length) {
            signalsMetaTextEl.textContent = "Takip edilen coin yok.";
            return;
        }

        let haveAny = false;
        for (const symbol of symbols) {
            const sig = state.aiSignals[symbol];
            if (!sig) continue;
            haveAny = true;

            const card = document.createElement("div");
            card.className = "signal-card";
            card.addEventListener("click", () => {
                state.selectedCoin = symbol;
                updateActionBarFromSignal();
                updateLayerSummaryFromSignal();
            });

            const direction = (sig.ensemble_prediction && sig.ensemble_prediction.direction) || "NEUTRAL";
            const confidence =
                sig.ensemble_prediction && typeof sig.ensemble_prediction.confidence === "number"
                    ? sig.ensemble_prediction.confidence
                    : null;

            let badgeClass = "signal-neutral";
            let badgeLabel = "Neutral";
            if (direction === "BUY" && confidence !== null && confidence >= 0.85) {
                badgeClass = "signal-strong-buy";
                badgeLabel = "Strong Buy";
            } else if (direction === "SELL" && confidence !== null && confidence >= 0.85) {
                badgeClass = "signal-strong-sell";
                badgeLabel = "Strong Sell";
            } else if (direction === "BUY") {
                badgeClass = "signal-strong-buy";
                badgeLabel = "Buy";
            } else if (direction === "SELL") {
                badgeClass = "signal-strong-sell";
                badgeLabel = "Sell";
            }

            const ts = sig.timestamp || null;
            const tsLabel = ts ? new Date(ts).toLocaleTimeString("tr-TR", {hour12:false}) : "â€“";

            const confText = confidence !== null ? (confidence * 100).toFixed(1) + "%" : "â€“";

            const agreement = sig.agreement_score;
            const agreementText =
                typeof agreement === "number"
                    ? (agreement * 100).toFixed(0) + "%"
                    : "â€“";

            card.innerHTML = `
                <div>
                    <span class="signal-badge ${badgeClass}">${badgeLabel}</span>
                </div>
                <div class="signal-main">
                    <div>
                        <div class="signal-symbol">${symbol}</div>
                        <div class="signal-detail">
                            Ensemble yÃ¶n: <strong>${direction}</strong> â€¢ Model anlaÅŸma: ${agreementText}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="signal-confidence">${confText}</div>
                        <div class="signal-time">${tsLabel}</div>
                    </div>
                </div>
                <div class="signal-models">
                    ${renderModelChips(sig.model_predictions)}
                </div>
            `;
            signalsGridEl.appendChild(card);
        }

        if (!haveAny) {
            signalsMetaTextEl.textContent = "HenÃ¼z aktif AI sinyali yok.";
        } else {
            signalsMetaTextEl.textContent = "Ultra AI tÃ¼m coinler iÃ§in aktif.";
        }

        updateActionBarFromSignal();
        updateLayerSummaryFromSignal();
    }

    function renderModelChips(modelPreds) {
        if (!modelPreds || typeof modelPreds !== "object") {
            return "";
        }
        const parts = [];
        const names = ["lstm", "xgboost", "random_forest", "gradient_boosting"];
        const labels = {
            lstm: "LSTM",
            xgboost: "XGB",
            random_forest: "RF",
            gradient_boosting: "GB"
        };
        for (const key of names) {
            const mp = modelPreds[key];
            if (!mp) continue;
            const dir = mp.direction || "â€“";
            const conf = typeof mp.confidence === "number" ? (mp.confidence * 100).toFixed(0) + "%" : "â€“";
            parts.push(
                `<span class="signal-model-chip"><strong>${labels[key]}:</strong> ${dir} â€¢ ${conf}</span>`
            );
        }
        return parts.join("");
    }

    function updateActionBarFromSignal() {
        selectedCoinEl.textContent = state.selectedCoin;
        const sig = state.aiSignals[state.selectedCoin];
        if (!sig || !sig.ensemble_prediction) {
            aiRecommendationEl.textContent = "â€“";
            aiConfidenceEl.textContent = "â€“";
            btnBuyEl.disabled = true;
            btnSellEl.disabled = true;
            btnCloseEl.disabled = true;
            return;
        }
        const dir = sig.ensemble_prediction.direction || "NEUTRAL";
        const conf = typeof sig.ensemble_prediction.confidence === "number"
            ? sig.ensemble_prediction.confidence
            : null;

        aiRecommendationEl.textContent = dir;
        aiConfidenceEl.textContent = conf !== null ? (conf * 100).toFixed(1) + "%" : "â€“";

        // Basit kural: NEUTRAL'de butonlar pasif, BUY/SELL'de aktif
        if (dir === "BUY") {
            btnBuyEl.disabled = false;
            btnSellEl.disabled = true;
        } else if (dir === "SELL") {
            btnBuyEl.disabled = true;
            btnSellEl.disabled = false;
        } else {
            btnBuyEl.disabled = true;
            btnSellEl.disabled = true;
        }
        btnCloseEl.disabled = false;
    }

    // ---- WEBSOCKET ----
    function initWebSocket() {
        const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") +
            location.host +
            "/ws/dashboard";

        try {
            const ws = new WebSocket(wsUrl);
            state.ws = ws;
            state.wsReconnectAttempts = 0;
            wsStatusEl.textContent = "Connectingâ€¦";

            ws.onopen = () => {
                state.wsConnected = true;
                wsStatusEl.textContent = "Connected";
                aiStatusDotEl.style.background = "#22c55e";
                aiStatusTextEl.textContent = "AI engine aktif";
                pingLatency();
            };

            ws.onmessage = (event) => {
                const now = performance.now();
                if (state.lastWsPing !== null) {
                    const diff = now - state.lastWsPing;
                    latencyTextEl.textContent = `${diff.toFixed(0)} ms`;
                    state.lastWsPing = null;
                }

                try {
                    const parsed = JSON.parse(event.data);
                    // Beklenen format: { type: 'ai_snapshot',  { symbol: {...}, ... } }
                    if (parsed && parsed.type === "ai_snapshot" && parsed.data) {
                        state.aiSignals = parsed.data;
                        renderSignals();
                    }
                } catch (err) {
                    console.error("WS parse error:", err);
                }
            };

            ws.onclose = () => {
                state.wsConnected = false;
                wsStatusEl.textContent = "Disconnected";
                aiStatusDotEl.style.background = "#f87171";
                aiStatusTextEl.textContent = "AI baÄŸlantÄ±sÄ± koptu, yeniden deneniyorâ€¦";
                latencyTextEl.textContent = "â€“";
                scheduleReconnect();
            };

            ws.onerror = (err) => {
                console.error("WebSocket error:", err);
            };
        } catch (err) {
            console.error("WebSocket init error:", err);
            scheduleReconnect();
        }
    }

    function pingLatency() {
        state.lastWsPing = performance.now();
        // Backend, ping iÃ§in Ã¶zel mesaj gerektirmiyorsa sadece zaman damgasÄ± alÄ±yoruz
    }

    function scheduleReconnect() {
        state.wsReconnectAttempts += 1;
        const attempt = state.wsReconnectAttempts;
        const delay = Math.min(30000, 1000 * Math.pow(2, attempt)); // 1,2,4,8.. max 30sn
        setTimeout(() => {
            initWebSocket();
        }, delay);
    }

    // ---- PERIODIC POLLING (FALLBACK) ----
    function startPolling() {
        // Fiyatlar iÃ§in: 30 saniyede bir
        fetchPrices();
        setInterval(fetchPrices, 30000);

        // AI snapshot fallback (WS yoksa)
        setInterval(async () => {
            if (state.wsConnected) return;
            try {
                const qs = encodeURIComponent(state.coins.join(","));
                const res = await fetch(`${API_BASE}/api/ai/snapshot?symbols=${qs}`, {cache: "no-store"});
                if (!res.ok) return;
                const data = await res.json();
                if (data && data.signals) {
                    state.aiSignals = data.signals;
                    renderSignals();
                }
            } catch (err) {
                console.error("AI snapshot fallback error:", err);
            }
        }, 30000);
    }

    // ---- INIT ----
    window.addEventListener("DOMContentLoaded", async () => {
        initTabs();
        initCoinForm();
        await fetchCoins();
        await fetchPrices();
        initWebSocket();
        startPolling();
    });
})();
</script>
</body>
</html>
